---
/**
 * Página dinámica que maneja todos los slugs del sitio
 * Detecta automáticamente si es un post, una categoría o una página estática
 */
import Layout from '../layouts/Layout.astro';
import ContentResolver from '../components/ContentResolver.astro';
import { useContentResolver } from '../hooks/useContentResolver';

// Obtener el slug de la URL
const { slug } = Astro.params;

// Obtener el parámetro de página de la URL
const page = parseInt(Astro.url.searchParams.get('page') || '1');

// Usar el hook para resolver el contenido con el parámetro de página
const resolvedContent = await useContentResolver(slug || '', page);

console.log(`[...slug].astro: Resolviendo contenido para slug '${slug}', página ${page}`);

// Guardar datos en locals para el middleware de analytics
if (resolvedContent.type === 'post' && resolvedContent.data) {
  const post = resolvedContent.data;
  
  // Extraer la primera categoría del post si existe
  const primaryCategory = post.categories?.nodes?.[0] || post.categories?.[0] || null;
  
  Astro.locals.post = {
    id: post.id || post.databaseId || '',
    databaseId: post.databaseId || '',
    title: post.title || '',
    slug: post.slug || slug || ''
  };
  
  // Guardar también la categoría del post
  if (primaryCategory) {
    Astro.locals.category = {
      slug: primaryCategory.slug || '',
      name: primaryCategory.name || ''
    };
  }
} else if (resolvedContent.type === 'category' && resolvedContent.data) {
  Astro.locals.category = {
    slug: resolvedContent.data.slug || slug || '',
    name: resolvedContent.data.name || ''
  };
}

// Obtener el título para la página
const pageTitle = resolvedContent.meta.title;

---

<Layout title={pageTitle}>
  <ContentResolver content={resolvedContent} />
</Layout>
