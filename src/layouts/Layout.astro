---
import '../styles/global.css';
import DarkModeToggle from '../components/DarkModeToggle.astro';
import { getMenuItems } from '../lib/wordpress.js';

const menuItems = await getMenuItems();

interface Props {
  title: string;
  description?: string;
  noFooter?: boolean;
}

const { title, description = "Amaqueme - Tu fuente de noticias locales", noFooter = false } = Astro.props;
---

<!DOCTYPE html>
<html class="light" lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <meta name="description" content={description} />
    <title>{title}</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FS8S918HPD"></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-FS8S918HPD');
    </script>
    <script async src="https://www.googleoptimize.com/optimize.js?id=OPT-NLZW5JG"></script>

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8763186523641960"
     crossorigin="anonymous"></script>
    <script is:inline>
      // Script inlined para evitar parpadeo al cargar la página
      const isDarkMode = localStorage.getItem('darkMode') === 'true';

      if (isDarkMode) {
        document.documentElement.classList.add('dark');
        document.documentElement.classList.remove('light');
      } else {
        document.documentElement.classList.remove('dark');
        document.documentElement.classList.add('light');
        if (!localStorage.getItem('darkMode')) {
          localStorage.setItem('darkMode', 'false');
        }
      }
    </script>
  </head>
  <body class="bg-[#fcfcfc] dark:bg-background-dark text-text-main dark:text-white font-display overflow-x-hidden min-h-screen flex flex-col antialiased pb-24 lg:pb-0">

    <!-- Header -->
    <header class="sticky top-0 z-50 w-full bg-white/95 backdrop-blur dark:bg-[#111722]/95 border-b border-gray-100 dark:border-[#232f48]">
      <div class="max-w-[1440px] mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16 sm:h-20 gap-4">
          <!-- Logo -->
          <a href="/" class="flex items-center gap-2 text-slate-900 dark:text-white shrink-0 group">
            <h1 class="text-xl sm:text-2xl font-bold tracking-tight group-hover:text-primary transition-colors">Amaqueme</h1>
          </a>

          <!-- Desktop Navigation -->
          <nav class="hidden lg:flex items-center gap-8 ml-auto mr-8">
            {menuItems.map((item) => {
              const hasSubmenu = item.childItems?.nodes?.length > 0;
              const cleanedPath = item.path?.replace(/^https?:\/\/[^\/]+/, '').replace(/\/\//g, '/') || '/';

              if (hasSubmenu) {
                return (
                  <div class="relative group">
                    <a href={cleanedPath} class="text-[15px] font-medium text-slate-600 hover:text-slate-900 dark:text-gray-300 dark:hover:text-white transition-colors flex items-center gap-1 cursor-pointer">
                      {item.label} <span class="material-symbols-outlined text-[16px]">expand_more</span>
                    </a>
                    <div class="absolute left-0 top-full mt-2 w-56 bg-white dark:bg-[#111722] border border-gray-100 dark:border-[#232f48] rounded-xl shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
                      {item.childItems.nodes.map((child) => {
                        const childCleanedPath = child.path?.replace(/^https?:\/\/[^\/]+/, '').replace(/\/\//g, '/') || '/';
                        return (
                          <a href={childCleanedPath} class="block px-4 py-2.5 text-sm font-medium text-slate-700 hover:text-primary hover:bg-gray-50 dark:text-gray-300 dark:hover:text-white dark:hover:bg-surface-dark transition-colors first:rounded-t-xl last:rounded-b-xl">
                            {child.label}
                          </a>
                        );
                      })}
                    </div>
                  </div>
                );
              }
              return (
                <a href={cleanedPath} class="text-[15px] font-medium text-slate-600 hover:text-slate-900 dark:text-gray-300 dark:hover:text-white transition-colors">
                  {item.label}
                </a>
              );
            })}
            <a href="/categorias" class="text-[15px] font-medium text-slate-600 hover:text-slate-900 dark:text-gray-300 dark:hover:text-white transition-colors">Categorías</a>
          </nav>

          <!-- Actions -->
          <div class="flex items-center gap-2 sm:gap-3 shrink-0">
            <!-- Desktop Search -->
            <button class="hidden lg:flex items-center justify-center size-10 rounded-full bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 text-slate-600 dark:text-gray-300 transition-colors">
              <span class="material-symbols-outlined text-[20px]">search</span>
            </button>
            <!-- Dark Mode Toggle -->
            <button id="dark-mode-toggle" class="flex items-center justify-center size-9 sm:size-10 rounded-full bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 text-slate-600 dark:text-gray-300 transition-colors">
              <span class="material-symbols-outlined text-[20px] dark-icon">dark_mode</span>
              <span class="material-symbols-outlined text-[20px] light-icon hidden">light_mode</span>
            </button>
            <!-- Mobile Menu Button -->
            <button id="mobile-header-menu" class="flex lg:hidden items-center justify-center size-9 rounded-full bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 text-slate-600 dark:text-gray-300 transition-colors">
              <span class="material-symbols-outlined text-[20px]">menu</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu-overlay" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden" style="display: none;"></div>

    <!-- Mobile Menu Drawer -->
    <div id="mobile-menu-drawer" class="fixed top-0 right-0 h-full w-[280px] bg-white dark:bg-[#111722] z-50 transform translate-x-full transition-transform duration-300 lg:hidden shadow-xl">
      <div class="flex flex-col h-full">
        <!-- Menu Header -->
        <div class="flex items-center justify-between p-4 border-b border-gray-100 dark:border-[#232f48]">
          <h3 class="text-lg font-bold text-slate-900 dark:text-white">Menú</h3>
          <button id="close-mobile-menu" class="flex items-center justify-center size-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-slate-600 dark:text-gray-300 transition-colors">
            <span class="material-symbols-outlined text-[20px]">close</span>
          </button>
        </div>

        <!-- Menu Items -->
        <nav class="flex-1 overflow-y-auto p-4">
          <ul class="space-y-1">
            {menuItems.map((item) => {
              const hasSubmenu = item.childItems?.nodes?.length > 0;
              const cleanedPath = item.path?.replace(/^https?:\/\/[^\/]+/, '').replace(/\/\//g, '/') || '/';

              if (hasSubmenu) {
                return (
                  <li>
                    <div class="mobile-menu-item-with-sub">
                      <a href={cleanedPath} class="flex items-center justify-between px-3 py-2.5 text-[15px] font-medium text-slate-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-surface-dark rounded-lg transition-colors">
                        {item.label}
                        <span class="material-symbols-outlined text-[18px] mobile-submenu-icon">expand_more</span>
                      </a>
                      <ul class="mobile-submenu ml-4 space-y-1 mt-1 hidden">
                        {item.childItems.nodes.map((child) => {
                          const childCleanedPath = child.path?.replace(/^https?:\/\/[^\/]+/, '').replace(/\/\//g, '/') || '/';
                          return (
                            <li>
                              <a href={childCleanedPath} class="block px-3 py-2 text-sm text-slate-600 dark:text-gray-400 hover:text-primary hover:bg-gray-50 dark:hover:bg-surface-dark rounded-lg transition-colors">
                                {child.label}
                              </a>
                            </li>
                          );
                        })}
                      </ul>
                    </div>
                  </li>
                );
              }

              return (
                <li>
                  <a href={cleanedPath} class="block px-3 py-2.5 text-[15px] font-medium text-slate-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-surface-dark rounded-lg transition-colors">
                    {item.label}
                  </a>
                </li>
              );
            })}
            <li>
              <a href="/categorias" class="block px-3 py-2.5 text-[15px] font-medium text-slate-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-surface-dark rounded-lg transition-colors">
                Categorías
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </div>

    <script is:inline>
      // Dark mode toggle
      document.addEventListener('DOMContentLoaded', () => {
        const toggle = document.getElementById('dark-mode-toggle');
        const darkIcon = toggle?.querySelector('.dark-icon');
        const lightIcon = toggle?.querySelector('.light-icon');

        const updateIcons = () => {
          const isDark = document.documentElement.classList.contains('dark');
          if (darkIcon && lightIcon) {
            if (isDark) {
              darkIcon.classList.add('hidden');
              lightIcon.classList.remove('hidden');
            } else {
              darkIcon.classList.remove('hidden');
              lightIcon.classList.add('hidden');
            }
          }
        };

        updateIcons();

        toggle?.addEventListener('click', () => {
          const isDark = document.documentElement.classList.contains('dark');
          if (isDark) {
            document.documentElement.classList.remove('dark');
            document.documentElement.classList.add('light');
            localStorage.setItem('darkMode', 'false');
          } else {
            document.documentElement.classList.add('dark');
            document.documentElement.classList.remove('light');
            localStorage.setItem('darkMode', 'true');
          }
          updateIcons();
        });

        // Mobile menu functionality
        const mobileMenuBtn = document.getElementById('mobile-header-menu');
        const mobileMenuDrawer = document.getElementById('mobile-menu-drawer');
        const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
        const closeMobileMenu = document.getElementById('close-mobile-menu');

        const openMobileMenu = () => {
          mobileMenuDrawer?.classList.remove('translate-x-full');
          mobileMenuOverlay.style.display = 'block';
          setTimeout(() => mobileMenuOverlay?.classList.add('opacity-100'), 10);
          document.body.style.overflow = 'hidden';
        };

        const closeMobileMenuFunc = () => {
          mobileMenuDrawer?.classList.add('translate-x-full');
          mobileMenuOverlay?.classList.remove('opacity-100');
          setTimeout(() => {
            mobileMenuOverlay.style.display = 'none';
          }, 300);
          document.body.style.overflow = '';
        };

        mobileMenuBtn?.addEventListener('click', openMobileMenu);
        closeMobileMenu?.addEventListener('click', closeMobileMenuFunc);
        mobileMenuOverlay?.addEventListener('click', closeMobileMenuFunc);

        // Mobile submenu toggle
        document.querySelectorAll('.mobile-menu-item-with-sub > a').forEach(item => {
          item.addEventListener('click', (e) => {
            e.preventDefault();
            const parent = item.parentElement;
            const submenu = parent?.querySelector('.mobile-submenu');
            const icon = parent?.querySelector('.mobile-submenu-icon');

            if (submenu) {
              submenu.classList.toggle('hidden');
              icon?.classList.toggle('rotate-180');
            }
          });
        });
      });
    </script>

    <script>
      // Inicializar protección contra copia
      import { setupCopyProtection } from '../utils/preventCopy.js';
      document.addEventListener('DOMContentLoaded', () => {
        setupCopyProtection();
      });
    </script>

    <!-- Main Content -->
    <main class="flex-grow w-full">
      <slot />
    </main>

    <!-- Mobile Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 z-50 w-full bg-white dark:bg-[#111722] border-t border-gray-200 dark:border-[#232f48] lg:hidden pb-safe shadow-up">
      <div class="grid grid-cols-5 h-16 items-center justify-items-center">
        <a href="/" class="flex flex-col items-center gap-1 text-primary w-full h-full justify-center transition-colors mobile-nav-item" data-active="true">
          <span class="material-symbols-outlined text-[24px]">home</span>
          <span class="text-[10px] font-medium">Inicio</span>
        </a>
        <a href="/categorias" class="flex flex-col items-center gap-1 text-slate-500 dark:text-gray-400 hover:text-slate-900 dark:hover:text-white w-full h-full justify-center transition-colors mobile-nav-item">
          <span class="material-symbols-outlined text-[24px]">map</span>
          <span class="text-[10px] font-medium">Municipios</span>
        </a>
        <a href="/categorias" class="flex flex-col items-center gap-1 text-slate-500 dark:text-gray-400 hover:text-slate-900 dark:hover:text-white w-full h-full justify-center transition-colors mobile-nav-item">
          <span class="material-symbols-outlined text-[24px]">grid_view</span>
          <span class="text-[10px] font-medium">Temas</span>
        </a>
        <a href="#" class="flex flex-col items-center gap-1 text-slate-500 dark:text-gray-400 hover:text-slate-900 dark:hover:text-white w-full h-full justify-center transition-colors mobile-nav-item">
          <span class="material-symbols-outlined text-[24px]">bookmark</span>
          <span class="text-[10px] font-medium">Guardados</span>
        </a>
        <button id="mobile-menu-btn" class="flex flex-col items-center gap-1 text-slate-500 dark:text-gray-400 hover:text-slate-900 dark:hover:text-white w-full h-full justify-center transition-colors">
          <span class="material-symbols-outlined text-[24px]">menu</span>
          <span class="text-[10px] font-medium">Menú</span>
        </button>
      </div>
    </nav>

    {!noFooter && (
      <footer class="bg-white dark:bg-[#0b1019] border-t border-gray-100 dark:border-[#232f48] pt-12 sm:pt-16 pb-24 sm:pb-8 mt-12 sm:mt-20">
        <div class="max-w-[1440px] mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex flex-col md:flex-row justify-between items-start gap-12 mb-12">
            <!-- Brand -->
            <div class="max-w-sm">
              <h4 class="text-2xl font-bold text-slate-900 dark:text-white mb-6">Amaqueme</h4>
              <p class="text-slate-500 dark:text-gray-400 mb-6 leading-relaxed">
                Información veraz y oportuna para un mundo en constante cambio. Tu fuente confiable de noticias locales y globales.
              </p>
              <div class="flex gap-4">
                <a href="#" class="size-10 rounded-full bg-gray-50 flex items-center justify-center text-slate-400 hover:text-primary hover:bg-green-50 transition-colors">
                  <span class="material-symbols-outlined text-[20px]">public</span>
                </a>
                <a href="#" class="size-10 rounded-full bg-gray-50 flex items-center justify-center text-slate-400 hover:text-primary hover:bg-green-50 transition-colors">
                  <span class="material-symbols-outlined text-[20px]">share</span>
                </a>
                <a href="#" class="size-10 rounded-full bg-gray-50 flex items-center justify-center text-slate-400 hover:text-primary hover:bg-green-50 transition-colors">
                  <span class="material-symbols-outlined text-[20px]">rss_feed</span>
                </a>
              </div>
            </div>

            <!-- Links -->
            <div class="flex flex-wrap gap-12 md:gap-24">
              <div>
                <h4 class="font-bold text-slate-900 dark:text-white mb-4">Secciones</h4>
                <ul class="space-y-3 text-sm text-slate-500 dark:text-gray-400">
                  <li><a href="/categorias" class="hover:text-primary transition-colors">Municipios</a></li>
                  <li><a href="/seguridad" class="hover:text-primary transition-colors">Seguridad</a></li>
                  <li><a href="/educacion" class="hover:text-primary transition-colors">Educación</a></li>
                  <li><a href="/sociedad" class="hover:text-primary transition-colors">Sociedad</a></li>
                </ul>
              </div>
              <div>
                <h4 class="font-bold text-slate-900 dark:text-white mb-4">Compañía</h4>
                <ul class="space-y-3 text-sm text-slate-500 dark:text-gray-400">
                  <li><a href="#" class="hover:text-primary transition-colors">Sobre Nosotros</a></li>
                  <li><a href="#" class="hover:text-primary transition-colors">Carreras</a></li>
                  <li><a href="#" class="hover:text-primary transition-colors">Publicidad</a></li>
                  <li><a href="#" class="hover:text-primary transition-colors">Contacto</a></li>
                </ul>
              </div>
              <div>
                <h4 class="font-bold text-slate-900 dark:text-white mb-4">Legal</h4>
                <ul class="space-y-3 text-sm text-slate-500 dark:text-gray-400">
                  <li><a href="#" class="hover:text-primary transition-colors">Términos</a></li>
                  <li><a href="#" class="hover:text-primary transition-colors">Privacidad</a></li>
                  <li><a href="#" class="hover:text-primary transition-colors">Cookies</a></li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Copyright -->
          <div class="border-t border-gray-100 dark:border-gray-800 pt-8 flex flex-col md:flex-row justify-between items-center gap-4 text-xs text-slate-400 dark:text-gray-500 font-medium">
            <p>© {new Date().getFullYear()} Amaqueme. Todos los derechos reservados.</p>
            <div class="flex gap-6">
              <a href="#" class="hover:text-slate-900 dark:hover:text-white transition-colors">Accesibilidad</a>
              <a href="#" class="hover:text-slate-900 dark:hover:text-white transition-colors">Centro de ayuda</a>
            </div>
          </div>
        </div>
      </footer>
    )}
  </body>
</html>
