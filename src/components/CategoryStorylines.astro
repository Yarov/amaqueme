---
// Componente para mostrar artículos de una categoría específica en formato Storylines
// Diseño moderno basado en la referencia visual
import { getPostsByCategory } from "../lib/wordpress";
import { getPostImage } from '../utils/getPostImage';

interface Props {
  categorySlug: string;
  categoryTitle?: string;
  maxPosts?: number;
}

const { categorySlug, categoryTitle, maxPosts = 6 } = Astro.props;

// Obtener posts de la categoría especificada
const { posts } = await getPostsByCategory(categorySlug, 1, maxPosts);

// Título por defecto si no se proporciona uno
const displayTitle = categoryTitle || (posts.length > 0 && posts[0].categories?.nodes?.[0]?.name) || categorySlug;

// Determinar iniciales para el badge basado en el nombre de la categoría
const getCategoryBadge = (categoryName: string) => {
  return categoryName.substring(0, 2).toUpperCase();
};

// Determinar color del badge basado en el slug de la categoría
const getBadgeColor = (slug: string) => {
  const s = slug.toLowerCase();
  if (s.includes('laberinto')) return 'bg-green-100 text-green-800';
  if (s.includes('atlautla')) return 'bg-blue-100 text-blue-800';
  if (s.includes('amecameca')) return 'bg-indigo-100 text-indigo-800';
  if (s.includes('chalco')) return 'bg-purple-100 text-purple-800';
  if (s.includes('tlalmanalco')) return 'bg-orange-100 text-orange-800';
  return 'bg-gray-100 text-gray-800';
};
---

<section class="border-t border-gray-100 pt-8 sm:pt-12 w-full bg-[#fcfcfc] dark:bg-background-dark">
  <div class="max-w-[1440px] mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-end justify-between mb-6 sm:mb-8">
      <div>
        <h2 class="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-white tracking-tight mb-1 sm:mb-2">{displayTitle}</h2>
        <p class="text-sm sm:text-base text-text-muted dark:text-gray-400">Mantente al día con los temas tendencia</p>
      </div>
      <a href={`/${categorySlug}`} class="text-primary hover:text-primary-dark font-medium text-sm flex items-center gap-1 transition-colors">
        Ver más <span class="material-symbols-outlined text-[16px]">chevron_right</span>
      </a>
    </div>

    {posts.length > 0 ? (
      <div class="flex overflow-x-auto md:grid md:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 pb-4 md:pb-0 -mx-4 px-4 md:mx-0 md:px-0 scrollbar-hide snap-x">
        {posts.slice(0, 4).map((post, index) => {
          const category = post.categories?.nodes?.[0];
          const categoryName = category?.name || "General";
          const categorySlug = category?.slug || "general";
          const badge = getCategoryBadge(categoryName);
          const badgeColor = getBadgeColor(categorySlug);
          const isLast = index === 3;

          return (
            <div class={`min-w-[85%] sm:min-w-[45%] md:min-w-0 snap-center bg-white dark:bg-surface-dark rounded-2xl overflow-hidden shadow-sm hover:shadow-lg transition-all duration-300 group flex flex-col h-full border border-gray-100 dark:border-transparent ${isLast ? 'relative' : ''}`}>
              <div class="relative aspect-[4/3] overflow-hidden">
                <div
                  class="absolute inset-0 bg-cover bg-center transition-transform duration-500 group-hover:scale-110"
                  style={`background-image: url('${getPostImage(post).url}'); ${isLast ? 'opacity: 0.6;' : ''}`}
                ></div>
                <div class={`absolute top-3 left-3 ${badgeColor} text-[11px] font-bold px-2 py-1 rounded uppercase tracking-wide`}>
                  {badge}
                </div>
              </div>
              <div class="p-4 sm:p-5 flex flex-col flex-1">
                <span class="text-xs font-semibold text-slate-500 dark:text-gray-400 uppercase mb-2">{categoryName}</span>
                <h3 class="text-lg font-bold text-slate-900 dark:text-white leading-tight mb-auto group-hover:text-primary transition-colors">
                  <a href={`/${post.slug}`}>{post.title}</a>
                </h3>
                <div class="flex items-center justify-between mt-4 text-xs text-slate-400">
                  <span>{post.author?.node?.name || 'Redacción'}</span>
                  <span>{new Date(post.date).toLocaleDateString('es-MX', { month: 'short', day: 'numeric' })}</span>
                </div>
              </div>

              {isLast && posts.length > 4 && (
                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/50 to-white/90 dark:via-background-dark/50 dark:to-background-dark/90 pointer-events-none flex items-center justify-end pr-8">
                  <a href={`/${categorySlug}`} class="pointer-events-auto size-12 rounded-full bg-white dark:bg-surface-light shadow-lg flex items-center justify-center text-slate-600 dark:text-slate-300 hover:text-primary transition-colors">
                    <span class="material-symbols-outlined">arrow_forward</span>
                  </a>
                </div>
              )}
            </div>
          );
        })}
      </div>
    ) : (
      <div class="flex items-center justify-center h-[200px] bg-gray-100 dark:bg-surface-dark rounded-xl">
        <div class="text-center p-8">
          <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-2">No hay artículos disponibles</h3>
          <p class="text-gray-600 dark:text-gray-300">No se encontraron artículos en esta categoría.</p>
        </div>
      </div>
    )}
  </div>
</section>

<style>
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>
