---
import { getPostsByCategory } from "../lib/wordpress";
import { getPostImage } from '../utils/getPostImage';

interface Props {
  categorySlug: string;
  categoryTitle?: string;
  maxPosts?: number;
}

const { categorySlug, categoryTitle, maxPosts = 6 } = Astro.props;

const { posts } = await getPostsByCategory(categorySlug, 1, maxPosts);

const displayTitle = categoryTitle || (posts.length > 0 && posts[0].categories?.nodes?.[0]?.name) || categorySlug;
---

<section class="w-full">
  <div class="max-w-[1440px] mx-auto px-4 sm:px-6 lg:px-8">
    <div class="bg-black text-white -mx-4 sm:-mx-6 lg:-mx-8 sm:rounded-3xl py-12 px-4 sm:px-12 relative overflow-hidden">
      <div class="absolute top-0 right-0 p-32 bg-primary blur-[120px] opacity-20 pointer-events-none"></div>
      <div class="absolute bottom-0 left-0 p-32 bg-purple-600 blur-[120px] opacity-20 pointer-events-none"></div>
      <div class="relative z-10">
        <div class="flex items-center justify-between mb-8">
          <div>
            <span class="text-primary font-bold tracking-wider text-xs uppercase mb-1 block">Exclusivo</span>
            <h2 class="font-display text-3xl font-bold text-white">{displayTitle}</h2>
          </div>
          <div class="flex items-center gap-2">
            <button 
              id={`scroll-btn-back-${categorySlug}`}
              class="size-10 rounded-full border border-white/20 flex items-center justify-center text-white hover:bg-white hover:text-black transition-colors"
              aria-label="Ver artículos anteriores"
            >
              <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <button 
              id={`scroll-btn-forward-${categorySlug}`}
              class="size-10 rounded-full border border-white/20 flex items-center justify-center text-white hover:bg-white hover:text-black transition-colors"
              aria-label="Ver más artículos"
            >
              <span class="material-symbols-outlined">arrow_forward</span>
            </button>
          </div>
        </div>
        <div 
          id={`scroll-container-${categorySlug}`}
          class="flex overflow-x-scroll gap-6 pb-6 -mx-4 px-4 sm:-mx-12 sm:px-12 snap-x snap-mandatory scrollbar-hide"
        >
          {posts.slice(0, maxPosts).map((post) => (
            <a href={`/${post.slug}`} class="snap-center shrink-0 w-[300px] group block">
              <div class="relative aspect-[16/10] overflow-hidden rounded-xl mb-4">
                <div
                  class="absolute inset-0 bg-cover bg-center transition-transform duration-500 group-hover:scale-110"
                  style={`background-image: url('${getPostImage(post).url}');`}
                ></div>
                <div class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition-colors"></div>
              </div>
              <h3 class="font-display font-bold text-xl leading-tight mb-2 text-white group-hover:text-primary transition-colors">{post.title}</h3>
              <p class="text-gray-400 text-sm line-clamp-2">
                {post.excerpt ? post.excerpt.replace(/<[^>]*>/g, '').substring(0, 100) + '...' : 'Análisis profundo sobre los movimientos políticos internos.'}
              </p>
            </a>
          ))}
        </div>
      </div>
    </div>
  </div>
</section>

<script define:vars={{ categorySlug }}>
  document.addEventListener('DOMContentLoaded', () => {
    const scrollBtnBack = document.getElementById(`scroll-btn-back-${categorySlug}`);
    const scrollBtnForward = document.getElementById(`scroll-btn-forward-${categorySlug}`);
    const scrollContainer = document.getElementById(`scroll-container-${categorySlug}`);
    
    const cardWidth = 300; // Width of each card
    const gap = 24; // gap-6 = 24px
    const scrollAmount = cardWidth + gap;
    
    // Function to update button visibility
    const updateButtonVisibility = () => {
      if (!scrollContainer || !scrollBtnBack || !scrollBtnForward) return;
      
      const scrollLeft = scrollContainer.scrollLeft;
      const maxScroll = scrollContainer.scrollWidth - scrollContainer.clientWidth;
      
      // Hide back button if at the start (with small threshold)
      if (scrollLeft <= 10) {
        scrollBtnBack.style.display = 'none';
      } else {
        scrollBtnBack.style.display = 'flex';
      }
      
      // Hide forward button if at the end (with small threshold)
      if (scrollLeft >= maxScroll - 10) {
        scrollBtnForward.style.display = 'none';
      } else {
        scrollBtnForward.style.display = 'flex';
      }
    };
    
    // Initial check
    updateButtonVisibility();
    
    // Update on scroll
    if (scrollContainer) {
      scrollContainer.addEventListener('scroll', updateButtonVisibility);
    }
    
    if (scrollBtnBack && scrollContainer) {
      scrollBtnBack.addEventListener('click', () => {
        scrollContainer.scrollBy({
          left: -scrollAmount,
          behavior: 'smooth'
        });
      });
    }
    
    if (scrollBtnForward && scrollContainer) {
      scrollBtnForward.addEventListener('click', () => {
        scrollContainer.scrollBy({
          left: scrollAmount,
          behavior: 'smooth'
        });
      });
    }
  });
</script>

<style>
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .snap-x {
    scroll-snap-type: x mandatory;
  }
  .snap-center {
    scroll-snap-align: center;
  }
</style>
